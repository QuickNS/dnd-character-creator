{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-xl-10 col-lg-11 mx-auto">
        <div class="card shadow-lg">
            <div class="card-header text-center">
                <h2>
                    <i class="fas fa-dna me-2"></i> Choose Your {{ character.species }} Lineage
                </h2>
                <p class="mb-0 text-white">Select your {{ character.species }} lineage to determine specific traits and abilities.</p>
            </div>
            <div class="card-body">
                
                <form method="POST" action="{{ url_for('select_lineage') }}">
                    <div class="row">
                        {% for lineage_name, lineage_data in lineages.items() %}
                        <div class="col-sm-6 col-lg-4 mb-3">
                            <div class="card lineage-card" data-lineage="{{ lineage_name }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0 flex-grow-1">{{ lineage_name }}</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="lineage" 
                                                   id="lineage_{{ loop.index }}" value="{{ lineage_name }}" required>
                                        </div>
                                    </div>
                                    
                                    <!-- Scrollable content area -->
                                    <div class="features-wrapper">
                                        <div class="features-container">
                                            <!-- Description first -->
                                            <div class="lineage-description mb-3">
                                                <p class="text-muted small mb-0">{{ lineage_data.get('description', 'A unique lineage with special traits.') }}</p>
                                            </div>
                                            
                                            <!-- Special Traits -->
                                            {% if lineage_data.get('traits') %}
                                            <div class="lineage-traits">
                                                <h6 class="text-danger mb-2"><small>Special Traits:</small></h6>
                                                {% for trait_name, trait_data in lineage_data.traits.items() %}
                                                <div class="small text-muted mb-2">
                                                    <strong>{{ trait_name }}:</strong>
                                                    {% if trait_data is string %}
                                                        {{ trait_data }}
                                                    {% elif trait_data.description %}
                                                        {{ trait_data.description }}
                                                    {% else %}
                                                        {{ trait_data | string }}
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    </div>
                    
                    <!-- Spellcasting Ability Choice -->
                    {% set has_spellcasting = False %}
                    {% for name, lineage in lineages.items() %}
                        {% if lineage.get('spellcasting_ability_choices') %}
                            {% set has_spellcasting = True %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if has_spellcasting %}
                    <div class="card mb-4" id="spellcasting-choice">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Spellcasting Ability</h5>
                        </div>
                        <div class="card-body">
                            <p>Choose your spellcasting ability for lineage spells (as mentioned in the Elven Lineage trait):</p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="spellcasting_ability" value="Intelligence" id="spell_int" required>
                                        <label class="form-check-label" for="spell_int">
                                            <strong>Intelligence</strong><br>
                                            <small class="text-muted">Logic and reasoning</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="spellcasting_ability" value="Wisdom" id="spell_wis" required>
                                        <label class="form-check-label" for="spell_wis">
                                            <strong>Wisdom</strong><br>
                                            <small class="text-muted">Insight and perception</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="spellcasting_ability" value="Charisma" id="spell_cha" required>
                                        <label class="form-check-label" for="spell_cha">
                                            <strong>Charisma</strong><br>
                                            <small class="text-muted">Force of personality</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="text-center d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-arrow-right me-2"></i>Continue to Ability Scores
                        </button>
                        <a href="{{ url_for('choose_species') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Species
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.lineage-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid var(--dnd-medium-gray);
    height: 480px;
    margin-bottom: 20px;
    overflow: hidden;
}

.lineage-card:hover {
    transform: translateY(-2px);
    border-color: var(--dnd-red);
    box-shadow: 0 4px 16px rgba(220, 20, 60, 0.15);
}

.lineage-card.border-info {
    border-color: var(--dnd-red) !important;
    border-width: 3px;
    background: var(--dnd-light-gray);
}

.lineage-card .card-body {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    overflow: hidden;
}

.lineage-card .card-title {
    flex-shrink: 0;
    word-wrap: break-word;
}

.features-wrapper {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
    margin-top: 0.5rem;
}

.features-wrapper::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, white);
    pointer-events: none;
    z-index: 2;
}

.features-container {
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 8px;
    margin-right: -8px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.features-container::-webkit-scrollbar {
    width: 6px;
}

.features-container::-webkit-scrollbar-track {
    background: var(--dnd-light-gray);
    border-radius: 3px;
}

.features-container::-webkit-scrollbar-thumb {
    background: var(--dnd-medium-gray);
    border-radius: 3px;
}

.features-container::-webkit-scrollbar-thumb:hover {
    background: var(--dnd-red);
}

.lineage-description {
    border-bottom: 2px solid var(--dnd-red);
    padding-bottom: 8px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.lineage-traits {
    border-bottom: 1px solid var(--dnd-light-gray);
    padding-bottom: 8px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.lineage-traits:last-child {
    border-bottom: none;
}
</style>

<script>
const submitButton = document.querySelector('button[type="submit"]');

function validateForm() {
    const lineageSelected = document.querySelector('input[name="lineage"]:checked');
    const spellcastingSelected = document.querySelector('input[name="spellcasting_ability"]:checked');
    const hasSpellcasting = document.querySelector('input[name="spellcasting_ability"]') !== null;
    
    const isValid = lineageSelected && (!hasSpellcasting || spellcastingSelected);
    submitButton.disabled = !isValid;
}

document.querySelectorAll('.lineage-card').forEach(card => {
    card.addEventListener('click', function() {
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
        
        // Update visual selection
        document.querySelectorAll('.lineage-card').forEach(c => c.classList.remove('border-info'));
        this.classList.add('border-info');
        
        validateForm();
    });
});

document.querySelectorAll('input[name="spellcasting_ability"]').forEach(radio => {
    radio.addEventListener('change', validateForm);
});

// Initial validation
validateForm();
</script>
{% endblock %}