{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-11">
        <div class="card shadow-lg">
            <div class="card-header text-white d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-check-circle"></i> Character Complete!
                </h4>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('character_summary.character_sheet') }}" class="btn btn-primary btn-sm" target="_blank">
                        <i class="fas fa-file-pdf"></i> View Character Sheet
                    </a>
                    <button type="button" class="btn btn-primary btn-sm" onclick="showChoicesMade()">
                        <i class="fas fa-download"></i> Export Choices
                    </button>
                    <a href="{{ url_for('index.reset') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-redo"></i> Start Over
                    </a>
                </div>
            </div>
            <div class="card-body">
                        <h2>{{ character.name }}</h2>
                        
                        <!-- Character Information -->
                        <div class="card mb-4">
                            <div class="sub-card-header bg-secondary">
                                <h5 class="mb-0">Character Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <p><strong>Level:</strong> {{ character.level }}</p>
                                        <p><strong>Class:</strong> {{ character.class }}{% if character.subclass %} ({{ character.subclass }}){% endif %}</p>
                                        <p><strong>Background:</strong> {{ character.background }}</p>
                                    </div>
                                    <div class="col-sm-6">
                                        <p><strong>Species:</strong> {{ character.species }}{% if character.lineage %} ({{ character.lineage }}){% endif %}</p>
                                        <p><strong>Alignment:</strong> {{ character.alignment }}</p>
                                        <p><strong>Languages:</strong> {{ character.languages | join(', ') }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Combat Statistics -->
                        <div class="card mb-4">
                            <div class="sub-card-header bg-secondary">
                                <h5 class="mb-0">Combat Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6 col-md-4">
                                        <p><strong>Hit Points:</strong> {{ character.max_hp }}</p>
                                        <p><strong>Armor Class:</strong> {{ combat_stats.armor_class }}</p>
                                        <p><strong>Initiative:</strong> {% if combat_stats.initiative >= 0 %}+{% endif %}{{ combat_stats.initiative }}</p>
                                    </div>
                                    <div class="col-sm-6 col-md-4">
                                        <p><strong>Speed:</strong> {{ character.speed | default(30) }} feet</p>
                                        {% if character.darkvision and character.darkvision > 0 %}
                                        <p><strong>Darkvision:</strong> {{ character.darkvision }} feet</p>
                                        {% endif %}
                                        <p><strong>Passive Perception:</strong> {{ combat_stats.passive_perception }}</p>
                                    </div>
                                    <div class="col-sm-6 col-md-4">
                                        <p><strong>Hit Dice:</strong> {{ combat_stats.hit_dice }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ability Scores and Skills side by side -->
                        <div class="row mb-4">
                            <div class="col-md-5">
                                <div class="card mb-3">
                                    <div class="sub-card-header bg-secondary">
                                        <h5 class="mb-0">Ability Scores</h5>
                                    </div>
                                    <div class="card-body">
                                        {% for ability, score in character.ability_scores.items() %}
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>{{ ability }}:</span>
                                            <span>{{ score }} 
                                                {% set modifier = (score - 10) // 2 %}
                                                <small class="text-muted">({% if modifier >= 0 %}+{% endif %}{{ modifier }})</small>
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Saving Throws -->
                                <div class="card mb-3">
                                    <div class="sub-card-header bg-secondary">
                                        <h5 class="mb-0">Saving Throws</h5>
                                    </div>
                                    <div class="card-body">
                                        {% for save in saving_throws %}
                                        <div class="d-flex justify-content-between mb-2 {% if save.is_proficient %}fw-bold{% endif %}">
                                            <span>
                                                {{ save.ability }}{% if save.is_proficient %} ★{% endif %}
                                            </span>
                                            <span>{% if save.total_modifier >= 0 %}+{% endif %}{{ save.total_modifier }}</span>
                                        </div>
                                        {% endfor %}
                                        <hr class="my-2">
                                        <small class="text-muted">★ = Proficient</small>
                                        
                                        {% set saves_with_notes = saving_throws | selectattr('special_notes', 'defined') | selectattr('special_notes') | list %}
                                        {% if saves_with_notes %}
                                        <div class="mt-2">
                                            <small class="text-success">
                                                <strong>Special Notes:</strong><br/>
                                                {% for save in saves_with_notes %}
                                                    <strong>{{ save.ability }}:</strong> {{ save.special_notes | join(', ') }}<br/>
                                                {% endfor %}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-7">
                                <div class="card">
                                    <div class="sub-card-header bg-secondary">
                                        <h5 class="mb-0">Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        {% for skill in skill_modifiers %}
                                            <div class="d-flex justify-content-between mb-1 {% if skill.is_proficient or skill.special_bonus > 0 %}fw-bold{% endif %}">
                                                <span>
                                                    {% if skill.is_proficient %}{{ skill.name }} ★{% elif skill.special_bonus > 0 %}{{ skill.name }} ✦{% else %}{{ skill.name }}{% endif %}
                                                    <small class="text-muted">({{ skill.ability[:3] }})</small>
                                                    {% if skill.proficiency_source %}
                                                        <small class="text-info" title="From {{ skill.proficiency_source }}">• {{ skill.proficiency_source }}</small>
                                                    {% endif %}
                                                    {% if skill.bonus_source %}
                                                        <small class="text-warning" title="{{ skill.bonus_source }}">• {{ skill.bonus_source.split('(')[0].strip() }}</small>
                                                    {% endif %}
                                                </span>
                                                <span>
                                                    {% if skill.total_modifier >= 0 %}+{% endif %}{{ skill.total_modifier }}
                                                </span>
                                            </div>
                                        {% endfor %}
                                        
                                        <hr class="my-2">
                                        <small class="text-muted">
                                            ★ = Proficient
                                            {% if ability_bonuses %}| ✦ = Special Bonus{% endif %}
                                        </small>
                                        
                                        {% if ability_bonuses %}
                                        <div class="mt-2">
                                            <small class="text-info">
                                                <strong>Special Bonuses:</strong><br/>
                                                {% for bonus in ability_bonuses %}
                                                    +{{ bonus.value }} to {{ bonus.ability }} checks ({{ bonus.skills | join(', ') }}) from {{ bonus.source }}<br/>
                                                {% endfor %}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Equipment Training & Proficiencies + Inventory - Side by Side -->
                        <div class="row mb-4">
                            <div class="col-lg-6 mb-4 mb-lg-0">
                                <div class="card h-100">
                                    <div class="sub-card-header bg-secondary">
                                        <h5 class="mb-0">Equipment Training & Proficiencies</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if weapon_proficiencies %}
                                        <div class="mb-2">
                                            <strong>Weapon Proficiencies:</strong><br/>
                                            <small>{{ weapon_proficiencies | join(', ') }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        {% if armor_proficiencies %}
                                        <div class="mb-2">
                                            <strong>Armor Proficiencies:</strong><br/>
                                            <small>{{ armor_proficiencies | join(', ') }}</small>
                                        </div>
                                        {% endif %}
                                        
                                        {% if character.tool_proficiencies %}
                                        <div class="mb-2">
                                            <strong>Tool Proficiencies:</strong><br/>
                                            <small>{{ character.tool_proficiencies | join(', ') }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="card h-100">
                                    <div class="sub-card-header bg-secondary">
                                        <h5 class="mb-0">Inventory</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if inventory %}
                                        <ul class="list-unstyled mb-0">
                                            {% for item in inventory %}
                                            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                                                <div>
                                                    <strong>{{ item.name }}</strong>
                                                    {% if quantity in item and item.quantity > 1 %}
                                                        <span class="badge bg-secondary ms-1">x{{ item.quantity }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if item.equippable %}
                                                <button class="btn-sm-inactive btn-outline-primary" disabled>
                                                    Equip
                                                </button>
                                                {% endif %}
                                            </li>
                                            {% endfor %}
                                        </ul>
                                        {% else %}
                                        <p class="text-muted mb-0">No equipment selected yet.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if character.features %}
                        <div class="card mb-4">
                            <div class="sub-card-header bg-secondary">
                                <h5 class="mb-0">Features & Traits</h5>
                            </div>
                            <div class="card-body">
                                {% for category in ['class', 'subclass', 'species', 'lineage', 'background', 'feats'] %}
                                    {% if category in character.features and character.features[category] %}
                                        {% for feature in character.features[category] %}
                                        <div class="mb-3">
                                            <p class="small mb-0">
                                            <strong>{{ feature.name }}</strong>
                                                {% if category == 'feats' %}
                                                <span class="badge bg-info ms-1">Feat</span>
                                                {% endif %}</br>
                                            {{ feature.description | safe }}</p>
                                            {% if feature.benefits %}
                                            <ul class="small mt-1 mb-0">
                                                {% for benefit in feature.benefits %}
                                                <li>{{ benefit }}</li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if feature.source %}
                                            <small class="text-muted">(from {{ feature.source }})</small>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if spells_by_level %}
                        <div class="card mb-4">
                            <div class="sub-card-header bg-secondary">
                                <h5 class="mb-0">Spellcasting</h5>
                            </div>
                            <div class="card-body">
                                {% if spell_slots %}
                                <div class="alert alert-info mb-3">
                                    <strong>Spell Slots:</strong>
                                    {% for slot_level, slot_count in spell_slots.items() | sort %}
                                        <span class="badge bg-primary ms-2">Level {{ slot_level }}: {{ slot_count }} slots</span>
                                    {% endfor %}
                                    <br>
                                    <small class="text-muted mt-1 d-block">You regain all expended slots when you finish a Long Rest.</small>
                                </div>
                                {% endif %}
                                
                                {% for level in spells_by_level | dictsort %}
                                    {% set level_num = level[0] %}
                                    {% set spells = level[1] %}
                                    {% if spells %}
                                    <div class="mb-3">
                                        <h6 class="text-primary">
                                            {% if level_num == 0 %}
                                                <strong>Cantrips</strong>
                                            {% else %}
                                                <strong>Level {{ level_num }} Spells</strong>
                                            {% endif %}
                                        </h6>
                                        {% for spell in spells %}
                                            {% if spell.get('is_note') %}
                                                <div class="alert alert-info py-2 mb-2">
                                                    <small><strong>{{ spell.name }}:</strong> {{ spell.description }}</small>
                                                </div>
                                            {% else %}
                                                <div class="mb-2">
                                                    <strong>{{ spell.name }}</strong>
                                                    {% if spell.get('always_prepared') %}
                                                        <span class="badge bg-info">Always Prepared</span>
                                                    {% endif %}
                                                    {% if spell.get('once_per_day') %}
                                                        <span class="badge bg-info">1/Day (No Slot)</span>
                                                    {% endif %}
                                                    <br>
                                                    <small class="text-muted">
                                                        {% if spell.school %}<strong>School:</strong> {{ spell.school }} | {% endif %}
                                                        {% if spell.casting_time %}<strong>Casting Time:</strong> {{ spell.casting_time }} | {% endif %}
                                                        {% if spell.range %}<strong>Range:</strong> {{ spell.range }} | {% endif %}
                                                        {% if spell.components %}<strong>Components:</strong> {{ spell.components }} | {% endif %}
                                                        {% if spell.duration %}<strong>Duration:</strong> {{ spell.duration }}{% endif %}
                                                    </small>
                                                    <br>
                                                    <small>{{ spell.description }}</small>
                                                    <br>
                                                    <small class="text-muted"><em>Source: {{ spell.source }}</em></small>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                
                <!-- Debug: Choices Made - moved to bottom -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0 text-muted">Debug: Choices Made</h6>
                            </div>
                            <div class="card-body">
                                <small class="text-muted">
                                    {% for key, value in character.choices_made.items() %}
                                    <div><strong>{{ key | title }}:</strong> 
                                        {% if value is iterable and value is not string %}
                                            {{ value | join(', ') }}
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Export Choices -->
<style>
#choicesModal {
    z-index: 1060 !important;
}
#choicesModal .modal-dialog {
    z-index: 1061 !important;
    pointer-events: auto !important;
}
#choicesModal .modal-content {
    pointer-events: auto !important;
}
#choicesModal .modal-content * {
    pointer-events: auto !important;
}
.modal-backdrop {
    z-index: 1059 !important;
    pointer-events: none !important;
}
</style>

<div class="modal fade" id="choicesModal" tabindex="-1" aria-labelledby="choicesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="choicesModalLabel">Export Choices Made</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>This JSON allows you to recreate your character in a later session:</p>
        <textarea id="choicesJson" class="form-control" rows="15" readonly style="font-family: monospace; background: white;">{{ character.choices_made | tojson(indent=2) }}</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" onclick="downloadChoices()">
          <i class="fas fa-download"></i> Download JSON
        </button>
        <button type="button" class="btn btn-primary" onclick="copyChoices(event)">
          <i class="fas fa-copy"></i> Copy to Clipboard
        </button>

      </div>
    </div>
  </div>
</div>

<script>
function showChoicesMade() {
    const modalElement = document.getElementById('choicesModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,
        keyboard: true,
        focus: true
    });
    modal.show();
}

function copyChoices(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const textarea = document.getElementById('choicesJson');
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    
    // Use modern clipboard API if available
    if (navigator.clipboard) {
        navigator.clipboard.writeText(textarea.value).then(() => {
            showCopyFeedback(event.target);
        }).catch(() => {
            document.execCommand('copy');
            showCopyFeedback(event.target);
        });
    } else {
        document.execCommand('copy');
        showCopyFeedback(event.target);
    }
}

function showCopyFeedback(btnElement) {
    const btn = btnElement.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
    }, 2000);
}

function downloadChoices() {
    const textarea = document.getElementById('choicesJson');
    const jsonContent = textarea.value;
    const characterName = "{{ character.name | replace(' ', '_') }}";
    const filename = `${characterName}_choices.json`;
    
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}
</script>

{% endblock %}